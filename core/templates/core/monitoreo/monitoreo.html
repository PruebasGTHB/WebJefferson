{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Monitoreo</title>
  <link rel="stylesheet" href="{% static '../static/css/styles_monitoreo.css' %}" />
  <link rel="icon" href="{% static 'img/logos/LOGO2+ALFA.png' %}" sizes="64x64" type="image/png">
  <meta name="csrf-token" content="{{ csrf_token }}">

  <!-- LibrerÃ­as externas -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/Draggable.min.js"></script>
  <script src="https://unpkg.com/@panzoom/panzoom/dist/panzoom.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/leader-line"></script>
  <script src="https://cdn.jsdelivr.net/npm/@svgdotjs/svg.js@3.2/dist/svg.min.js"></script>

</head>
<body>

<div id="canvas-wrapper">
  <div id="svg-connections" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;"></div>

  <div id="overlay-canvas"></div>
  <div id="loader-monitoreo">
    <div class="loader-brand-monitoreo">FOODCORP</div>
    <div class="loader-bar-monitoreo"></div>
  </div>

  <div id="canvas"></div>
  </div>
  <div id="loader-seccion">
    <div class="spinner-seccion"></div>
  </div>

<!-- Modal -->
<div id="grafanaModal">
  <div class="contenedor_modal">
    <div id="loader" class="spinner-overlay">
      <div class="energy-spinner"></div>
      <div id="loader-text" class="loader-text">FOODCORP</div>
    </div>
    <button class="cerrarModal" onclick="cerrarModal()">âœ–</button>
    <iframe id="grafanaIframe" src="" frameborder="0"></iframe>
  </div>
</div>

<!-- Sidebar -->
<div id="sidebar">
  <div class="menu-section">
    <h4>Empalmes</h4>
    <ul>
      <li onclick="cambiarCanvas('Vista General Planta')">Vista General Planta</li>
      <li onclick="cambiarCanvas('Empalme 1 Planta Harina')">Empalme 1 Planta Harina</li>
      <li onclick="cambiarCanvas('Empalme 2 Planta Congelado')">Empalme 2 Planta Congelado</li>
      <li onclick="cambiarCanvas('Empalme 3 PontÃ³n Tor')">Empalme 3 PontÃ³n Tor</li>
    </ul>
  </div>
  <div class="menu-section">
    <h4>Vista Procesos</h4>
    <ul>
      <li onclick="cambiarCanvas('General Flota')">General Flota</li>
      <li onclick="cambiarCanvas('Sala de Calderas')">Sala de Calderas</li>
      <li onclick="cambiarCanvas('Planta Harina')">Planta Harina</li>
      <li onclick="cambiarCanvas('Planta Congelado')">Planta Congelado</li>
    </ul>
  </div>
  <div class="menu-section">
    <h4>Ingreso de ProducciÃ³n</h4>
    <ul>
      <li onclick="cambiarCanvas('Flota')">Flota</li>
      <li onclick="cambiarCanvas('Planta Harina/Congelados')">Planta Harina/Congelados</li>
    </ul>
  </div>
  <!-- <div class="menu-section">
    <h4>HistÃ³ricos</h4>
    <ul>
      <li onclick="descargarDatosMensuales()">Descargar Datos Mensuales</li>
    </ul>
  </div> -->
  <div class="cerrar-sesion">
    <button onclick="cerrarSesion()">MenÃº principal</button>
  </div>
</div>

<!-- Scripts -->
<script>
  let panzoom, conexiones = [];
  
  function cambiarCanvas(seccion) {
  const canvas = document.getElementById('canvas');
  const loader = document.getElementById('loader-seccion');
  const overlay = document.getElementById('overlay-canvas');
  const sidebar = document.getElementById('sidebar');

  document.querySelectorAll('#sidebar ul li').forEach(li => li.classList.remove('active'));
  const activeItem = Array.from(document.querySelectorAll('#sidebar ul li')).find(li => li.textContent.trim() === seccion.trim());
  if (activeItem) activeItem.classList.add('active');

  loader.style.display = 'block';
  overlay.style.display = 'block';
  sidebar.classList.remove('open');

  if (conexiones.length) {
    conexiones.forEach(linea => linea.remove());
    conexiones = [];
  }

  canvas.innerHTML = '';

  fetch(`/api/posiciones/?seccion=${encodeURIComponent(seccion)}`)
    .then(res => res.json())
    .then(medidores => {
      medidores.forEach(med => {
        const card = document.createElement('div');
        card.className = 'medidor-card';
        card.dataset.medidor = med.medidor_id;
        card.dataset.editable = med.editable ? 'true' : 'false'; // ðŸ‘ˆ guardamos editable individual

        if (med.grafana_url) {
          card.dataset.grafanaUrl = med.grafana_url;
        }

        const chip = document.createElement(med.tipo === 'C' ? 'div' : 'span');
        chip.className = `icon-chip ${med.tipo === 'C' ? 'blue' : 'gray'}`; // ðŸ‘ˆ corregido template string
        chip.textContent = med.tipo;
        card.appendChild(chip);

        const h3 = document.createElement('h3');
        h3.textContent = med.titulo || med.medidor_id;
        card.appendChild(h3);

        // âœ… Ahora siempre creamos el bloque de energÃ­a
        const kWh = document.createElement('div');
        kWh.className = 'kWh';
        kWh.innerHTML = `ðŸ”„ <span class="valor energia_total"></span><div class="unidad">kWh</div>`; // ðŸ‘ˆ corregido
        card.appendChild(kWh);

        // âœ… Y tambiÃ©n siempre el bloque de potencia
        const kW = document.createElement('div');
        kW.className = 'kW';
        kW.innerHTML = `âš¡ <span class="valor potencia_actual"></span><div class="unidad">kW</div>`; // ðŸ‘ˆ corregido
        card.appendChild(kW);

        canvas.appendChild(card);
        gsap.set(card, { x: med.x ?? 0, y: med.y ?? 0 });
      });

      inicializarDrag();
      conectarMedidoresDesdeBD();
      configurarModales();
      actualizarMedidores();
      setTimeout(centrarCanvas, 100);
    })
    .finally(() => {
      setTimeout(() => {
        loader.style.display = 'none';
        overlay.style.display = 'none';
      }, 3000);
    });
}

  
  function inicializarDrag() {
    if (Draggable.get(".medidor-card")) {
      Draggable.getAll().forEach(d => d.kill());
    }
  
    document.querySelectorAll('.medidor-card').forEach(card => {
      const editable = card.dataset.editable === 'true'; // ðŸ‘ˆ verificamos cada medidor
  
      if (!editable) {
        console.log(`ðŸš« ${card.dataset.medidor} no es editable`);
        return; // si no es editable, no crear draggable
      }
  
      Draggable.create(card, {
        type: "x,y",
        bounds: "#canvas",
        inertia: false,
        minimumMovement: 3,
        onPress: function (e) {
          panzoom.setOptions({ disablePan: true });
          e.stopPropagation();
        },
        onDrag: function () {
          actualizarConexiones();
        },
        onRelease: function () {
          panzoom.setOptions({ disablePan: false });
          guardarSoloUnMedidor(this.target);
        }
      });
    });
  }
  
  function guardarSoloUnMedidor(card) {
    const id = card.dataset.medidor;
    if (!id) return;
  
    const draggable = Draggable.get(card);
    const x = draggable?.x ?? 0;
    const y = draggable?.y ?? 0;
  
    const payload = [{ medidor_id: id, x, y }];
  
    fetch('/api/guardar_posiciones/', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': document.querySelector('[name="csrf-token"]').content
      },
      body: JSON.stringify(payload)
    })
      .then(res => res.json())
      .then(data => console.log(`âœ… PosiciÃ³n guardada (${id}):`, data))
      .catch(err => console.error('âŒ Error al guardar posiciÃ³n:', err));
  }
  
  function configurarModales() {
    document.querySelectorAll('.medidor-card').forEach(card => {
      card.addEventListener('dblclick', () => {
        const grafanaUrl = card.dataset.grafanaUrl;
        if (!grafanaUrl) return;
  
        const iframe = document.getElementById('grafanaIframe');
        const modal = document.getElementById('grafanaModal');
        const loaderModal = document.getElementById('loader');
        const loaderText = document.getElementById('loader-text');
  
        loaderText.textContent = card.querySelector('h3').textContent;
        loaderModal.style.display = 'flex';
        modal.style.display = 'flex';
        iframe.src = grafanaUrl;
  
        iframe.onload = () => loaderModal.style.display = 'none';
      });
    });
  }
  
  function cerrarModal() {
    document.getElementById('grafanaModal').style.display = 'none';
    document.getElementById('grafanaIframe').src = '';
    document.getElementById('loader').style.display = 'none';
  }
  
  function descargarDatosMensuales() {
    alert('Descargando datos mensuales...');
  }
  
  function cerrarSesion() {
    window.location.href = '/menu';
  }
  
  function centrarCanvas() {
    const wrapper = document.getElementById('canvas-wrapper');
    const canvas = document.getElementById('canvas');
    requestAnimationFrame(() => {
      const wrapperRect = wrapper.getBoundingClientRect();
      const canvasWidth = canvas.offsetWidth;
      const canvasHeight = canvas.offsetHeight;
      const panX = (wrapperRect.width / 2) - (canvasWidth / 2);
      const panY = (wrapperRect.height / 2) - (canvasHeight / 2);
      panzoom.pan(panX, panY);
    });
  }
  
  function conectarMedidoresDesdeBD() {
    fetch('/api/conexiones/')
      .then(res => res.json())
      .then(conexionesConfig => {
        conexionesConfig.forEach(({ origen_id, destino_id, start_socket, end_socket }) => {
          const origen = document.querySelector(`[data-medidor="${origen_id}"]`);
          const destino = document.querySelector(`[data-medidor="${destino_id}"]`);
          if (!origen || !destino) return;
  
          const linea = new LeaderLine(origen, destino, {
            startSocket: start_socket,
            endSocket: end_socket,
            color: '#00ffff',
            size: 4,
            path: 'grid',
            endPlug: 'arrow3',
            outline: true,
            outlineColor: '#f9cf33',
            outlineSize: 2,
          });
          conexiones.push(linea);
        });
      });
  }
  
  function actualizarConexiones() {
    if (!window.LeaderLine || !conexiones.length) return;
    conexiones.forEach(linea => linea.position());
  }
  
  function actualizarMedidores() {
    document.querySelectorAll('.medidor-card').forEach(card => {
      const medidorId = card.dataset.medidor;
  
      fetch(`/api/consumos/${medidorId}/`)  // ðŸš€ Llamamos a tu vista en Django
        .then(response => response.json())
        .then(data => {
          const energiaElement = card.querySelector('.energia_total');
          const potenciaElement = card.querySelector('.potencia_actual');
  
          if (energiaElement && data.energia_total_kwh !== undefined) {
            energiaElement.textContent = data.energia_total_kwh;
          }
  
          if (potenciaElement && data.potencia_total_kw !== undefined) {
            potenciaElement.textContent = data.potencia_total_kw;
          }
        })
        .catch(error => {
          console.error(`Error al actualizar medidor ${medidorId}:`, error);
        });
    });
  }

  
  
  function bucleConexiones() {
    requestAnimationFrame(bucleConexiones);
  }
    
  window.onload = () => {
    document.getElementById('loader-monitoreo').style.display = 'none';
    panzoom = Panzoom(document.getElementById('canvas'), {
      canvas: true,
      contain: false,
      disablePan: false,
      disableZoom: false,
      minScale: 0.6,
      maxScale: 2.5,
      startScale: 0.9
    });
    cambiarCanvas('Vista General Planta');
  };
  </script>
  

  
</body>
</html>
